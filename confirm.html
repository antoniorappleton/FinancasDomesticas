<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Conta confirmada • Wisebudget</title>
  <style>
    :root{
      --green:#0b7a5d; --greenDark:#064e3b; --text:#0f172a;
      --ok:#16a34a; --err:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; display:grid; place-items:center; min-height:100%;
      background: linear-gradient(180deg, var(--greenDark), var(--green));
      font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:#fff;
    }
    .card{
      background:#fff; color:var(--text);
      border-radius:14px; padding:18px 20px; width:min(92vw, 560px);
      box-shadow:0 20px 50px rgba(0,0,0,.25);
      display:grid; gap:10px; text-align:center;
    }
    .title{font-weight:800; font-size:1.15rem}
    .ok{color:var(--ok); font-weight:700}
    .err{color:var(--err); font-weight:700}
    .hint{color:#475569; font-size:.9rem}
    .btn{
      display:inline-block; padding:10px 14px; border-radius:10px;
      background:var(--green); color:#fff; text-decoration:none; font-weight:700;
      border:1px solid rgba(255,255,255,.12);
    }
  </style>
</head>
<body>
  <div class="card" id="box">
    <div class="title">A confirmar a tua conta…</div>
    <div class="hint">Aguarda um instante.</div>
  </div>

  <!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ⚙️ Usa as MESMAS credenciais do index.html
  const SUPABASE_URL  = window.SUPABASE_URL  || "https://brakxcumzdleufrpyipm.supabase.co";
  const SUPABASE_ANON = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyYWt4Y3VtemRsZXVmcnB5aXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MTI1MzMsImV4cCI6MjA3NDE4ODUzM30.Y-zw1H1gTyJnFJ3lxbamY8hU1KOFG06ayLmXYMuVknA";
  const sb  = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const box = document.getElementById("box");
  const okUI = (msg="Conta confirmada ✔") => {
    box.innerHTML = `
      <div class="title">${msg}</div>
      <div class="ok">A redirecionar para o dashboard…</div>
      <a class="btn" href="./index.html#/">Ir agora</a>
    `;
    setTimeout(()=>location.href="./index.html#/?confirmed=1", 900);
  };
  const errUI = (err) => {
    box.innerHTML = `
      <div class="title">Ups, algo correu mal</div>
      <div class="err">${err?.message || err}</div>
      <div class="hint">Se o link já tiver sido usado, basta entrares na app.</div>
      <a class="btn" href="./index.html#/">Voltar à app</a>
    `;
  };

  // ✅ TESTE rápido manual: /confirm.html?ok=1
  const url  = new URL(location.href);
  if (url.searchParams.get("ok") === "1") { okUI("Simulação de sucesso"); }

  (async () => {
    try {
      // 1) OAuth (tem ?code=…)
      const code = url.searchParams.get("code");
      if (code) {
        const { error } = await sb.auth.exchangeCodeForSession(location.href);
        if (error) throw error;
        return okUI();
      }

      // 2) Tokens no fragmento #access_token=…&refresh_token=…
      // (alguns templates antigos/magic link podem vir assim)
      const hashParams = new URLSearchParams(location.hash.slice(1));
      const at = hashParams.get("access_token");
      const rt = hashParams.get("refresh_token");
      if (at && rt) {
        const { error } = await sb.auth.setSession({ access_token: at, refresh_token: rt });
        if (error) throw error;
        return okUI();
      }

      // 3) Links de email (confirm signup/recovery/invite/email_change)
      const token_hash = url.searchParams.get("token_hash");
      const type = url.searchParams.get("type"); // signup | recovery | invite | email_change
      if (token_hash && type) {
        const { error } = await sb.auth.verifyOtp({ type, token_hash });
        if (error) throw error;
        return okUI(type === "signup" ? "Email confirmado ✔" : "Ligação validada ✔");
      }

      // Se não detetámos nenhum dos formatos…
      throw new Error("Link inválido ou expirado.");
    } catch (err) {
      console.error(err);
      errUI(err);
    }
  })();
</script>

</body>
</html>
