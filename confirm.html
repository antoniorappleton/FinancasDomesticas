<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <title>Confirma√ß√£o | Wisebudget</title>
  <style>
    :root{ --g:#0b7a5d; --g2:#064e3b; --ok:#16a34a; --err:#ef4444; }
    html,body{height:100%} body{
      margin:0; display:grid; place-items:center;
      background:linear-gradient(180deg,var(--g2),var(--g));
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto;
      color:#0f172a;
    }
    .card{
      width:min(680px,94vw);
      background:#fff; border-radius:16px; padding:22px 20px;
      box-shadow:0 24px 60px rgba(0,0,0,.25);
    }
    h1{margin:0 0 6px; font-size:24px}
    .muted{color:#6b7280; margin:8px 0 16px}
    .msg{font-weight:800}
    .msg.ok{color:var(--ok)}
    .msg.err{color:var(--err)}
    .btn{display:block; width:100%; padding:12px 14px; margin-top:14px;
      border:0; border-radius:12px; font-weight:800; cursor:pointer;
      background:#0b7a5d; color:#fff;
    }
  </style>
  <script>
    // Garantir que n√£o h√° SW a servir vers√£o antiga desta p√°gina
    (async () => {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        regs.forEach(r => {
          // n√£o desregista o SW da app inteira; s√≥ evita controlar esta p√°gina
          // ao carregar sem escopo (GitHub Pages normalmente n√£o controla esta rota)
        });
      }
    })();
  </script>
</head>
<body>
  <div class="card" id="box">
    <h1 id="t">A confirmar‚Ä¶</h1>
    <p class="msg" id="m">Aguente s√≥ um segundo.</p>
    <p class="muted" id="hint"></p>
    <button class="btn" id="go">Voltar √† app</button>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Ajusta estes se quiseres instanciar aqui tamb√©m:
    const SUPABASE_URL  = window.SUPABASE_URL  || "https://brakxcumzdleufrpyipm.supabase.co";
    const SUPABASE_ANON = window.SUPABASE_ANON_KEY ||
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyYWt4Y3VtemRsZXVmcnB5aXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MTI1MzMsImV4cCI6MjA3NDE4ODUzM30.Y-zw1H1gTyJnFJ3lxbamY8hU1KOFG06ayLmXYMuVknA";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const $ = (id)=>document.getElementById(id);
    const t = $('t'), m = $('m'), hint = $('hint'), go = $('go');

    // Construir URL base para voltar √† app (funciona em GitHub Pages e localhost)
    const BASE = new URL(".", location.href).href;         // ‚Ä¶/FinancasDomesticas/
    const APP  = new URL("index.html", BASE).href;        // ‚Ä¶/FinancasDomesticas/index.html

    go.addEventListener('click', ()=> location.href = APP);

    async function run(){
      const params = new URLSearchParams(location.search);

      // 1) Teste manual: ?ok=1 => mostra sucesso
      if (params.get('ok') === '1') {
        t.textContent = "Conta confirmada üéâ";
        m.textContent = "Obrigado! A sua conta foi confirmada com sucesso.";
        m.className = "msg ok";
        hint.textContent = "Pode entrar j√° na aplica√ß√£o.";
        go.textContent = "Entrar";
        return;
      }

      // 2) Fluxo real: Supabase envia code + code_verifier
      const code = params.get('code');
      const verifier = params.get('code_verifier');

      if (!code || !verifier) {
        t.textContent = "Ups, algo correu mal";
        m.textContent = "Link inv√°lido ou expirado.";
        m.className = "msg err";
        hint.textContent = "Se o link j√° tiver sido usado, basta entrar na app.";
        go.textContent = "Voltar √† app";
        return;
      }

      try {
        const { data, error } = await sb.auth.exchangeCodeForSession(window.location.href);
        if (error) throw error;

        t.textContent = "Conta confirmada üéâ";
        m.textContent = "Obrigado! A sua conta foi confirmada com sucesso.";
        m.className = "msg ok";
        hint.textContent = "Vamos abrir a aplica√ß√£o.";
        go.textContent = "Entrar";
        // pequeno atraso para UX e depois ir para a app
        setTimeout(()=> location.href = APP + "#/", 900);
      } catch (err) {
        t.textContent = "Ups, algo correu mal";
        m.textContent = "N√£o foi poss√≠vel confirmar: " + (err?.message || err);
        m.className = "msg err";
        hint.textContent = "Pode tentar entrar na app; se estiver confirmado, j√° consegue.";
        go.textContent = "Voltar √† app";
      }
    }
    run();
  </script>
</body>
</html>
