<!doctype html>
<html lang="pt-PT">

<head>
  <script>
    window.APP_VERSION = "v22";
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Wisebudget® — Gestão Doméstica</title>

  <!-- Protocol Check & Loader -->
  <script>
    (function () {
      if (window.location.protocol === "file:") {
        // =========================
        // MODO FICHEIRO (Bloqueio UI)
        // =========================
        // Não carregamos main.js nem manifest.
        // Apenas mostramos o aviso quando o corpo estiver pronto.

        window.addEventListener("DOMContentLoaded", () => {
          document.body.innerHTML = `
              <div style="
                position:fixed;top:0;left:0;right:0;bottom:0;
                background:#111;color:#fff;z-index:99999;
                display:flex;flex-direction:column;align-items:center;justify-content:center;
                font-family:system-ui,sans-serif;text-align:center;padding:20px;
              ">
                <h1 style="color:#ef4444;margin-bottom:16px">⚠️ Modo de ficheiro detetado</h1>
                <p style="font-size:18px;line-height:1.6;max-width:500px">
                  Esta aplicação utiliza Módulos ES e Service Workers, que não funcionam diretamente do disco por segurança do browser.
                </p>
                <div style="background:#334155;padding:16px;border-radius:8px;margin-top:24px;font-family:monospace;font-size:16px">
                  npm run dev
                </div>
                <p style="margin-top:16px;color:#94a3b8">Execute o comando acima ou faça <strong style="color:#fff">duplo clique no ficheiro run.bat</strong> na pasta do projeto.</p>
              </div>
            `;
        });

        // Aviso na consola (sem throw Error para não parar o parsing do body)
        console.warn(
          "Aplicação em modo de ficheiro. Scripts principais não foram carregados.",
        );
      } else {
        // =========================
        // MODO SERVIDOR (Normal)
        // =========================

        // 1. Injeta Manifest
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = "./manifest.json?v=12";
        document.head.appendChild(link);

        // 2. Injeta main.js (module)
        // O fazemos no DOMContentLoaded ou defer para garantir ordem, mas como é module é defer por defeito.
        const script = document.createElement("script");
        script.type = "module";
        script.src = "./main.js";
        document.head.appendChild(script);
      }
    })();
  </script>

  <!-- PANIC SWITCH: desregista SW e limpa caches quando ?sw=off -->
  <script>
    (function () {
      if (!location.search.includes("sw=off")) return;
      (async () => {
        try {
          if ("serviceWorker" in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map((r) => r.unregister()));
          }
          if (window.caches?.keys) {
            const keys = await caches.keys();
            await Promise.all(keys.map((k) => caches.delete(k)));
          }
        } finally {
          location.replace(location.pathname);
        }
      })();
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;700;800&family=Outfit:wght@500;700;800&display=swap"
    rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#10b981",
            electric: "#0de3f2", // New Electric Cyan
            secondary: "#065f46",
            petroleum: "#0b1220",
            "background-light": "#f7f9fb",
            "background-dark": "#0b1220",
          },
          animation: {
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'flicker': 'flicker 3s infinite',
          },
          keyframes: {
            flicker: {
              '0%, 19.999%, 22%, 62.999%, 64%, 64.999%, 70%, 100%': { opacity: '1' },
              '20%, 21.999%, 63%, 63.999%, 65%, 69.999%': { opacity: '0.4' },
            }
          },
          fontFamily: {
            display: ["Manrope", "sans-serif"],
            brand: ["Outfit", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px",
          },
        },
      },
    };
  </script>
  <style>
    .glass-overlay {
      background: rgba(11, 18, 32, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    /* ELECTRIC THEME STYLES */
    .glass-card {
      background: rgba(16, 33, 34, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 0 40px rgba(13, 227, 242, 0.05);
    }

    .neon-text {
      color: #fff;
      text-shadow:
        0 0 5px rgba(255, 255, 255, 0.8),
        0 0 10px rgba(13, 227, 242, 0.5),
        0 0 20px rgba(13, 227, 242, 0.3);
    }

    .neon-box {
      box-shadow: 0 0 10px rgba(13, 227, 242, 0.2);
      border: 1px solid rgba(13, 227, 242, 0.3);
    }

    .gradient-electric {
      background: linear-gradient(135deg, #fff 0%, #0de3f2 50%, #10b981 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 15px rgba(13, 227, 242, 0.3));
    }

    .logo-glow {
      filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.3));
    }

    .gradient-text {
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Ensure loading screen is above everything */
    #wb-loading-screen {
      position: fixed;
      inset: 0;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    #wb-loading-screen.is-hiding {
      opacity: 0;
      pointer-events: none;
    }
  </style>
  <link rel="stylesheet" href="./styles.css" />
  <!-- Manifest inserido dinamicamente via JS acima -->
</head>

<body>
  <!-- Novo Loading Screen (Electric Theme) -->
  <div id="wb-loading-screen"
    class="font-brand bg-petroleum text-white overflow-hidden fixed inset-0 z-[9999] transition-opacity duration-500">
    <div class="relative flex h-screen w-full flex-col items-center justify-center overflow-hidden">

      <!-- Background Effect -->
      <div class="absolute inset-0 z-0">
        <div
          class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-electric/10 via-petroleum to-petroleum">
        </div>
        <div
          class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-electric/5 rounded-full blur-[100px] animate-pulse-fast">
        </div>
      </div>

      <!-- Main Content -->
      <div class="relative z-10 flex flex-col items-center gap-12">
        <!-- THE LOGO: CSS/SVG Construction -->
        <div class="relative">
          <!-- Glow behind -->
          <div class="absolute inset-0 bg-electric/20 blur-2xl rounded-full"></div>

          <div
            class="glass-card w-56 h-56 rounded-[2rem] flex items-center justify-center relative overflow-hidden neon-box group">
            <!-- CSS LOGO CONSTRUCTION -->
            <!-- Container for the House Shape -->
            <div class="relative w-40 h-40 flex items-end justify-between gap-[2px]"
              style="clip-path: polygon(50% 0%, 100% 35%, 100% 100%, 0% 100%, 0% 35%);">

              <!-- 13 Bars for finer resolution (Electric/Primary colors adjusted) -->
              <!-- Map Preview 'primary'(cyan) to 'electric' and 'secondary'(green) to 'primary' -->

              <!-- Rise 1 (Slope +8%) - First Half -->
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-electric h-[12%] animate-pulse-fast shadow-[0_0_8px_#0de3f2]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-electric h-[20%] animate-pulse-fast delay-75 shadow-[0_0_8px_#0de3f2]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-electric h-[28%] animate-pulse-fast delay-100 shadow-[0_0_8px_#0de3f2]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-electric h-[36%] animate-pulse-fast delay-150 shadow-[0_0_8px_#0de3f2]"></div>
              </div>

              <!-- Dip (36 -> 24 -> 12) - End of First Half -->
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div
                  class="w-[85%] bg-gradient-to-t from-electric to-primary h-[24%] animate-pulse-fast delay-200 shadow-[0_0_8px_#0de3f2]">
                </div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div
                  class="w-[85%] bg-gradient-to-t from-electric to-primary h-[12%] animate-pulse-fast delay-300 shadow-[0_0_8px_#10b981]">
                </div>
              </div>

              <!-- Rise 2 (Slope +8%) - Second Half -->
              <!-- Linear rise to 64% (just below 65% vertex) -->
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-primary h-[20%] animate-pulse-fast delay-400 shadow-[0_0_8px_#10b981]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-primary h-[28%] animate-pulse-fast delay-500 shadow-[0_0_8px_#10b981]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-primary h-[36%] animate-pulse-fast delay-600 shadow-[0_0_8px_#10b981]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-primary h-[44%] animate-pulse-fast delay-700 shadow-[0_0_8px_#10b981]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-primary h-[52%] animate-pulse-fast delay-800 shadow-[0_0_8px_#10b981]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-primary h-[60%] animate-pulse-fast delay-900 shadow-[0_0_8px_#10b981]"></div>
              </div>
              <div class="relative w-full h-full flex items-end justify-center">
                <div class="absolute inset-y-0 w-[1px] bg-white/30"></div>
                <div class="w-[85%] bg-primary h-[64%] animate-pulse-fast delay-1000 shadow-[0_0_8px_#10b981]"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Typography -->
        <div class="text-center space-y-2">
          <h1 class="text-6xl font-bold tracking-tighter animate-flicker">
            <span class="text-white">Wise</span><span class="gradient-electric">budget</span>
          </h1>
          <p class="text-electric/60 text-sm font-bold uppercase tracking-[0.3em] pl-1">
            Gestão Financeira
          </p>
        </div>

        <!-- Loading Bar -->
        <div class="w-64 space-y-3 mt-4">
          <div class="h-[2px] w-full bg-white/10 overflow-hidden relative">
            <div id="loading-bar"
              class="absolute inset-y-0 left-0 bg-gradient-to-r from-electric to-primary shadow-[0_0_15px_#0de3f2]"
              style="width: 0%; transition: width 0.1s linear;"></div>
          </div>
          <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest text-electric/80">
            <span id="loading-status">INICIALIZANDO</span>
            <span id="loading-pct">0%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script do Loading Screen -->
  <script>
    (function () {
      const bar = document.getElementById("loading-bar");
      const status = document.getElementById("loading-status");
      const pct = document.getElementById("loading-pct");
      const screen = document.getElementById("wb-loading-screen");

      let progress = 0;
      let isReady = false;

      // Listeners para quando a app estiver pronta
      window.addEventListener("load", () => { isReady = true; });
      window.addEventListener("app:ready", () => { isReady = true; });

      const interval = setInterval(() => {
        // Se a app já estiver pronta, acelera para 100%
        let increment = isReady ? 5 : (Math.random() * 1.5);

        // Se não estiver pronta, abranda perto do fim
        if (!isReady && progress > 85) {
          increment = 0.1; // Muito lento até estar ready
        }

        progress += increment;
        if (progress > 100) progress = 100;

        // Update UI
        if (bar) bar.style.width = `${progress}%`;
        if (pct) pct.innerText = `${Math.floor(progress)}%`;

        if (status) {
          if (progress < 30) status.innerText = "A LIGAR MOTORES...";
          else if (progress < 60) status.innerText = "A CARREGAR DADOS...";
          else if (progress < 90) status.innerText = "A SINCRONIZAR...";
          else status.innerText = "PRONTO";
        }

        // Finish
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            if (screen) {
              screen.classList.add("is-hiding"); // Use existing CSS class for opacity transition
              setTimeout(() => {
                screen.style.display = "none";
              }, 500);
            }
          }, 300);
        }
      }, 50);
    })();
  </script>

  <!-- FAB (opcional; podes remover se usares só o footer) -->
  <div class="fab-nav" aria-live="polite">
    <button id="fabToggle" class="fab-nav__toggle" aria-label="Abrir menu" aria-expanded="false">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M4 7h16v2H4zm0 5h16v2H4zm0 5h16v2H4" />
      </svg>
    </button>
    <div id="fabItems" class="fab-nav__items" hidden aria-hidden="true">
      <button class="fab-item" data-to="#/" aria-label="Dashboard">
        <svg>
          <use href="#i-home" />
        </svg><span class="fab-label">Dashboard</span>
      </button>
      <button class="fab-item" data-to="#/metas" aria-label="Metas">
        <svg>
          <use href="#i-target" />
        </svg><span class="fab-label">Metas</span>
      </button>
      <button class="fab-item" data-to="#/movimentos" aria-label="Movimentos">
        <svg>
          <use href="#i-receipt" />
        </svg><span class="fab-label">Movimentos</span>
      </button>
      <button class="fab-item" data-to="#/new" aria-label="Nova">
        <svg>
          <use href="#i-plus" />
        </svg><span class="fab-label">Nova</span>
      </button>
      <button class="fab-item" data-to="#/settings" aria-label="Definições">
        <svg>
          <use href="#i-cog" />
        </svg><span class="fab-label">Definições</span>
      </button>
    </div>
  </div>
</body>

</html>