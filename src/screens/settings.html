<!-- ===== MODAL RELATÓRIO ===== -->
<section class="card">
  <h2 class="section-title">Relatórios</h2>

  <!-- Filtro original (mantido) -->
  <div class="grid" style="grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px">
    <label>
      Tipo
      <select id="rpt-type">
        <option value="monthly" selected>Mensal</option>
        <option value="range">Intervalo de meses</option>
        <option value="yearly">Anual</option>
      </select>
    </label>

    <label id="rpt-month-wrap">
      Mês
      <input id="rpt-month" type="month" />
    </label>

    <label id="rpt-range-wrap" class="hidden">
      De (YYYY-MM)
      <input id="rpt-from" type="month" />
    </label>

    <label id="rpt-range2-wrap" class="hidden">
      Até (YYYY-MM)
      <input id="rpt-to" type="month" />
    </label>

    <label id="rpt-year-wrap" class="hidden">
      Ano
      <input id="rpt-year" type="number" min="2000" max="2100" step="1" />
    </label>
  </div>

  <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
    <button id="btn-report-open" class="btn btn--primary">Abrir relatório…</button>
  </div>
</section>

<div id="report-overlay" class="hidden rpt-overlay" aria-hidden="true" tabindex="-1">
  <div class="rpt-modal">

    <!-- Header com logo + título + fechar -->
    <div class="rep-header">
      <div class="rep-title">
        <img id="app-logo-img" class="rep-logo" src="/wisebudget_bk_wt.png" alt="Logo" />
        <h2 id="rpt-title">Relatório Financeiro</h2>
      </div>
      <button id="rpt-close" class="rpt-close" aria-label="Fechar">×</button>
    </div>

    <!-- Filtro no topo do modal (sincroniza com o filtro exterior) -->
    <div class="rpt-controls">
      <div class="rpt-controls__row">
        <label>
          Tipo
          <select id="rpt-type-inside">
            <option value="monthly" selected>Mensal</option>
            <option value="range">Intervalo de meses</option>
            <option value="yearly">Anual</option>
          </select>
        </label>
        <label id="rpt-month-inside-wrap">
          Mês
          <input id="rpt-month-inside" type="month" />
        </label>
        <label id="rpt-from-inside-wrap" class="hidden">
          De
          <input id="rpt-from-inside" type="month" />
        </label>
        <label id="rpt-to-inside-wrap" class="hidden">
          Até
          <input id="rpt-to-inside" type="month" />
        </label>
        <label id="rpt-year-inside-wrap" class="hidden">
          Ano
          <input id="rpt-year-inside" type="number" min="2000" max="2100" step="1" />
        </label>
      </div>
    </div>

    <!-- KPIs -->
    <div class="rpt-kpis">
      <div class="rpt-kpi"><div>Receitas</div><strong id="rpt-kpi-income">€ 0,00</strong></div>
      <div class="rpt-kpi"><div>Despesas</div><strong id="rpt-kpi-expense">€ 0,00</strong></div>
      <div class="rpt-kpi"><div>Poupanças</div><strong id="rpt-kpi-savings">€ 0,00</strong></div>
      <div class="rpt-kpi"><div>Saldo</div><strong id="rpt-kpi-balance">€ 0,00</strong></div>
    </div>

    <!-- Gráficos: Despesas por categoria & Fixas vs Variáveis (um em cima do outro) -->
    <div class="rpt-grid">
      <div class="rpt-card">
        <h3 class="rpt-card__title">Despesas por categoria</h3>
        <div class="chart"><canvas id="rpt-cat-pie"></canvas></div>
        <div id="rpt-cat-legend" class="rpt-legend"></div>
      </div>
      <div class="rpt-card">
        <h3 class="rpt-card__title">Fixas vs Variáveis</h3>
        <div class="chart"><canvas id="rpt-fixed-donut"></canvas></div>
        <div id="rpt-fv-legend" class="rpt-legend small"></div>
      </div>
    </div>

    <!-- Séries temporais -->
    <div class="rpt-card">
      <h3 class="rpt-card__title">Evolução mensal (receitas, despesas, poupanças, saldo)</h3>
      <div class="chart chart--tall"><canvas id="rpt-series"></canvas></div>
    </div>

    <!-- Tabelas -->
    <div class="rpt-grid rpt-grid--tables">
      <div class="rpt-card">
        <h3 class="rpt-card__title">Receitas por categoria</h3>
        <div class="rpt-table-wrap"><table id="tbl-income-cat"></table></div>
      </div>
      <div class="rpt-card">
        <h3 class="rpt-card__title">Despesas por categoria</h3>
        <div class="rpt-table-wrap"><table id="tbl-expense-cat"></table></div>
      </div>
      <div class="rpt-card">
        <h3 class="rpt-card__title">Resumo mensal & liquidez</h3>
        <div class="rpt-table-wrap"><table id="tbl-monthly"></table></div>
      </div>
      <div class="rpt-card">
        <h3 class="rpt-card__title">Despesas por regularidade</h3>
        <div class="chart"><canvas id="rpt-regularity"></canvas></div>
      </div>
    </div>

    <!-- Top 6 despesas (barras horizontais) -->
    <div class="rpt-card">
      <h3 class="rpt-card__title">Top 6 categorias de despesa</h3>
      <div class="chart"><canvas id="rpt-top-exp"></canvas></div>
    </div>

    <!-- Linhas de percentagens -->
    <div class="rpt-card">
      <div style="display:grid;grid-template-columns:1fr;gap:12px">
        <div>
          <h3 class="rpt-card__title">Taxa de esforço mensal</h3>
          <div class="chart"><canvas id="rpt-effort"></canvas></div>
        </div>
        <div>
          <h3 class="rpt-card__title">Taxa de poupança mensal</h3>
          <div class="chart"><canvas id="rpt-savings-rate"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Insights / Alertas -->
    <ul id="rpt-insights" class="rpt-insights"></ul>

    <div class="rpt-actions">
      <button id="rpt-export" class="btn">Exportar PDF</button>
    </div>
  </div>
</div>

<style>
  .hidden{display:none}

  /* Overlay + modal */
  .rpt-overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.5);
    display:flex; align-items:flex-start; justify-content:center;
    overflow:auto; padding:24px; z-index:1000;
  }
  .rpt-modal{
    background:#fff; width:min(1100px,92vw);
    border-radius:16px; padding:16px 20px 28px; position:relative; color:#111;
  }

  /* Header com logo */
  .rep-header{
    display:flex; align-items:center; justify-content:space-between;
    gap:120px; margin:-8px -4px 8px;
  }
    .rep-title { display:flex; align-items:center; gap:12px; }
    .rep-title h2 { font-size: 1.25rem; line-height: 1; margin: 0; }
    .rep-logo { height: 40px; width: auto; display:block; }

    /* queres maior? sobe para 34–40px: */
    @media (min-width: 720px){
      .rep-logo { height: 40px; }
      .rep-title h2 { font-size: 1.35rem; }
    }
  .rpt-close{ font-size:22px; line-height:1; background:transparent; border:0; cursor:pointer }

  /* Controles + KPIs */
  .rpt-controls{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; margin:8px 0 12px }
  .rpt-controls__row{ display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px }
  .rpt-kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:12px 0 }
  .rpt-kpi{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px }

  /* Cartões do relatório */
  .rpt-grid{ display:grid; grid-template-columns:1fr; gap:16px } /* pizzas empilhadas */
  .rpt-grid--tables{ grid-template-columns:1fr } /* tabelas empilhadas também; muda para 2fr 2fr se quiseres lado a lado */
  .rpt-card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px }
  .rpt-card__title{ margin:0 0 8px 0; font-size:14px }

  /* Chart wrapper — evita “crescimento infinito” */
  .chart{
    position:relative; width:100%;
    height:260px;
  }
  .chart.chart--tall{ height:320px }
  .chart.chart--short{ height:220px }
  .chart > canvas{
    position:absolute; inset:0;
    width:100% !important; height:100% !important; display:block;
  }

  /* Legendas */
  .rpt-legend{ margin-top:6px }
  .rpt-legend.small{ font-size:12px }
  .rpt-legend__item{ display:flex; align-items:center; gap:8px; padding:4px 0 }
  .rpt-legend__dot{ width:10px; height:10px; border-radius:50% }

  /* Tabelas */
  .rpt-table-wrap{ overflow:auto }
  .rpt-table-wrap table{ width:100%; border-collapse:collapse; font-size:13px }
  .rpt-table-wrap th,.rpt-table-wrap td{
    padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right; white-space:nowrap
  }
  .rpt-table-wrap th:first-child,.rpt-table-wrap td:first-child{ text-align:left }

  /* Insights */
  .rpt-insights{ margin:10px 0 0 0; padding-left:18px }
  .rpt-insights li{ margin:4px 0 }

  .btn{ padding:8px 12px; border:1px solid #334155; border-radius:10px; background:#111827; color:#e5e7eb; }

  /* Responsivo */
  @media (max-width: 900px){
    .rpt-controls__row{ grid-template-columns:1fr 1fr }
    .rpt-kpis{ grid-template-columns:1fr 1fr }
  }

  /* Print A4 vertical */
  @media print{
    body{ background:#fff }
    .rpt-overlay{ position:static; inset:auto; background:#fff; padding:0 }
    .rpt-modal{ width:auto; box-shadow:none; padding:0; border:none }
    .rpt-close,.rpt-actions{ display:none }
    .rpt-controls{ border:none; background:#fff }
    .rpt-card{ page-break-inside:avoid }
  }

  /* Gráficos pizza força 1:1 e evita crescer sem controlo */
  #rpt-cat-pie, #rpt-fixed-donut {
    aspect-ratio: 1 / 1;
    width: 100% !important;
    height: auto !important;
    max-height: 320px;   /* ajusta à vontade (280–360) */
    display: block;
  }


</style>

<!-- ===== secção categorias ===== -->
<section class="card">
  <h2 class="section-title">Categorias</h2>
  <p>Cria, edita ou remove as tuas categorias e subcategorias.</p>
  <a href="#/categories" class="btn btn--primary">Gerir categorias</a>
</section>

<!-- Sessão -->
<section class="card" id="card-session" style="margin-top:12px">
  <h2 class="section-title">Sessão</h2>
  <div class="grid" style="grid-template-columns:2fr 1fr;gap:10px;align-items:end">
    <div>
      <div class="row-note">Autenticado como:</div>
      <div id="sess-user-email" style="font-weight:700">—</div>
    </div>
    <div style="text-align:right">
      <button id="btn-logout" class="btn">Terminar sessão</button>
    </div>
  </div>
</section>

<!-- Alterar palavra-passe -->
<section id="sec-password" class="card">
  <h3 class="section-title">Alterar palavra-passe</h3>
  <div class="grid" style="grid-template-columns:1fr;gap:10px">
    <label>Nova palavra-passe
      <input id="set-new-pass" type="password" autocomplete="new-password" />
    </label>
    <label>Confirmar nova palavra-passe
      <input id="set-new-pass-2" type="password" autocomplete="new-password" />
    </label>
  </div>
  <div style="display:flex;gap:10px;margin-top:12px">
    <button id="btn-change-pass" class="btn btn--primary">Atualizar</button>
  </div>
  <div id="set-msg" class="row-note" style="margin-top:8px"></div>
</section>

<!-- ===== MODAL CSV ===== -->
<section class="card">
  <h2 class="section-title">Importação CSV</h2>

  <div class="form-grid">
    <label>
      Ficheiro CSV
      <input id="imp-file" type="file" accept=".csv,text/csv" />
    </label>
    <label>
      Mês (para registo)
      <input id="imp-month" type="month" />
    </label>
  </div>

  <div class="actions" style="margin-top:8px">
    <button id="imp-preview" class="btn">Pré-visualizar</button>
    <button id="imp-import"  class="btn btn--primary">Importar</button>
    <button id="imp-clear"   class="btn">Limpar pré-visualização</button>
    <button id="imp-export-template" class="btn">Exportar modelo Excel</button>
  </div>

  <p id="imp-info" class="row-note"></p>
  <pre id="imp-log" class="row-note" style="white-space:pre-wrap"></pre>

  <div id="imp-table-wrap" class="card soft" style="margin-top:12px; display:none">
    <h3 class="section-title">Pré-visualização</h3>
    <div style="overflow:auto">
      <table id="imp-table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

<script>
/* Resolve o logo do modal (tenta caminhos comuns e tem fallback SVG) */
(function resolveModalLogo(){
  const img = document.getElementById('app-logo-img');
  if (!img) return;

  const CANDIDATES = [
    './wisebudget_bk_wt.png',
    '/wisebudget_bk_wt.png',
    './assets/wisebudget_bk_wt.png',
    '/assets/wisebudget_bk_wt.png',
  ];

  const BUSTER = ''; // podes pôr '?v=2025-10-03' se precisares forçar refresh

  const tryOne = (u) =>
    fetch(u + BUSTER, { cache: 'no-store' })
      .then(r => r.ok ? u + BUSTER : null)
      .catch(() => null);

  (async () => {
    for (const u of CANDIDATES) {
      const ok = await tryOne(u);
      if (ok) { img.src = ok; return; }
    }
    // fallback
  const svg = encodeURIComponent(`
    <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
      <rect width='100%' height='100%' fill='black'/>
      <text x='50%' y='56%' fill='white' font-size='36' font-family='Helvetica, Arial, sans-serif' font-weight='700' text-anchor='middle'>W</text>
    </svg>`);
    img.src = 'data:image/svg+xml,' + svg;
  })();
})();
</script>


<!-- ===== MANUTENÇÃO DE DADOS ===== -->
<section class="card">
  <h2 class="section-title">Manutenção de Dados</h2>
  <div class="actions">
    <button id="btn-del-month" class="btn btn--primary" style="background:#ef4444;border-color:#ef4444">Eliminar Mês Atual</button>
    <button id="btn-del-range" class="btn">Eliminar Período…</button>
    <button id="btn-del-all" class="btn">Eliminar Tudo…</button>
    <button id="btn-regularity-bulk" class="btn">Definir Regularidade (bulk)…</button>
  </div>
  <p class="row-note">Estas ações afetam apenas os seus dados (RLS ativo).</p>
</section>


<script type="module" src="/src/main.js?v=v7"></script>
